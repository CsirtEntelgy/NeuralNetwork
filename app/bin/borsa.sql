CREATE TABLE BORSA(
  ID_AZIENDA INT PRIMARY KEY,
  AZIENDA TEXT,
  DETTAGLIO TEXT,
  SIGLA TEXT
);

CREATE TABLE STATO(
  ID_AZIENDA INTEGER PRIMARY KEY REFERENCES BORSA(ID_AZIENDA),
  ULTIMOAGGIORNAMENTO TEXT,
  ABILITATA BOOLEAN
);

CREATE TABLE DATI (
  ID_AZIENDA INTEGER,
  DATA TEXT,
  APERTURA TEXT,
  MASSIMO TEXT,
  MINIMO TEXT,
  ULTIMOVALORE TEXT,
  ADJ TEXT,
  VOLUME TEXT,
  PRIMARY KEY(ID_AZIENDA, DATA)
);

CREATE VIEW MAPPA AS
  SELECT
    B.AZIENDA AZIENDA,
    B.DETTAGLIO DETTAGLIO,
    B.SIGLA SIGLA,
    S.ULTIMOAGGIORNAMENTO ULTIMOAGGIORNAMENTO,
    S.ABILITATA ABILITATA,
    (
    SELECT
      COUNT(*)
    FROM
      DATI
    WHERE
      ID_AZIENDA=B.ID_AZIENDA) DATI,
      B.ID_AZIENDA ID_AZIENDA
    FROM
      BORSA B,
      STATO S
    WHERE
      S.ID_AZIENDA=B.ID_AZIENDA CREATE VIEW ABILITATE AS
      SELECT
        AZIENDA,
        DETTAGLIO,
        SIGLA,
        ULTIMOAGGIORNAMENTO,
        DATI,
        ID_AZIENDA
      FROM
        MAPPA
      WHERE
        ABILITATA=TRUE CREATE VIEW STATOAZIONI AS
        SELECT
          B.ID_AZIENDA ID_AZIENDA,
          B.AZIENDA AZIENDA,
          B.DETTAGLIO DETTAGLIO,
          B.SIGLA SIGLA,
          S.ULTIMOAGGIORNAMENTO ULTIMOAGGIORNAMENTO,
          S.ABILITATA ABILITATA,
          B.DATI DATI
        FROM
          MAPPA B,
          STATO S
        WHERE
          S.ID_AZIENDA=B.ID_AZIENDA;

CREATE VIEW AZIONE AS
  SELECT
    B.ID_AZIENDA ID_AZIENDA,
    AZIENDA,
    DETTAGLIO,
    SIGLA,
    DATA,
    APERTURA,
    MASSIMO,
    MINIMO,
    ULTIMOVALORE,
    VARIAZIONEPERCENTUALE,
    VOLUME
  FROM
    BORSA B
    JOIN DATI D
    ON D.ID_AZIENDA=B.ID_AZIENDA;

CREATE VIEW TREND AS
  SELECT
    ID_AZIENDA,
    DATA,
    APERTURA,
    MASSIMO,
    MINIMO,
    ULTIMOVALORE,
    ADJ,
    VOLUME,
    (ULTIMOVALORE-APERTURA)/ULTIMOVALORE VARIAZIONEPERCENTUALE
  FROM
    DATI;

CREATE TRIGGER TRG_AGGIORNAMENTO INSTEAD OF
  UPDATE OF ULTIMOAGGIORNAMENTO, ABILITATA ON STATOAZIONI
BEGIN
  UPDATE STATO
  SET
    ULTIMOAGGIORNAMENTO=NEW.ULTIMOAGGIORNAMENTO,
    ABILITATA=NEW.ABILITATA
  WHERE
    ID_AZIENDA IN (
      SELECT ID_AZIENDA FROM BORSA WHERE SIGLA=OLD.SIGLA
    );
END;
DELETE FROM STATO;
INSERT INTO STATO
  SELECT
    ID_AZIENDA,
    '',
    FALSE
  FROM
    BORSA;