<html>
<script src="riepilogo.js"></script>
<style>
  li {
    cursor: pointer;
  }
</style>

<body>
  <div>
    <div id="menu" style="float:left;width:300px;height:600px;overflow:auto;">
    </div>
    <div style="float:left;width:900px;overflow:auto;">
      <canvas id="gwin" width="800px" height="250px" style="border:1px solid #000000;">
      </canvas>
      <p></p>
      <canvas id="Perc" width="800px" height="250px" style="border:1px solid #000000;">
      </canvas>
      <table id="tabella" border="1" style="font-size:small;float:left;"></table>
      <table id="previsioni" border="1" style="font-size:small;float:right"></table>
    </div>
  </div>
</body>

<script>
  var idmenu = document.getElementById("menu")
  Object.keys(dati).forEach(k => {
    var t = dati[k];
    var hli = document.createElement("li");
    hli.innerHTML = `${t.azienda}${t.sigla ? " - " + t.sigla : ""}`
    hli.id = t.displayName;
    hli.azienda = t;
    hli.cursor = "pointer";
    hli.addEventListener("click", function ({ target }) {
      drawGraphs(target.azienda);
    });
    //localStorage.setItem(t.displayName, JSON.stringify(t));

    idmenu.appendChild(hli);
  });
  function tabella(id,s,e,x, y) {
    var idtab = document.getElementById(id);
    idtab.innerHTML = `<tr><td>Data</td><td>Valore</td></tr>`
    for (var i = s; i < e; i++) {
      idtab.innerHTML += `<tr><td>${x[i]}</td><td>${Math.round(y[i],3)}</td></tr>`
    }
  }
  var offx = 10, offy = 20;
  function drawGraphs(azienda) {
    var c = document.getElementById("gwin");
    var width = c.width, height = c.height;
    var minv = Math.min(...azienda.r1.errori),
      maxv = Math.max(...azienda.r1.errori);
    var alfax = (1.0 * width - 2 * offx) / azienda.r1.errori.length;
    var betax = offx;
    var alfay = (height - 2 * offy) / (minv - maxv);
    var betay = offy - alfay * maxv;
    drawPoints(c, azienda.r1.errori, `Errori ${azienda.azienda} elaborazione ${azienda.r1.ultimaElaborazione}`, { color: "red", alfax, alfay, betax, betay })
    c = document.getElementById("Perc");
    width = c.width, height = c.height;
    minv = Math.min(...azienda.r1.y);
    maxv = Math.max(...azienda.r1.y);
    minv = Math.min(minv, ...azienda.r1.yp);
    maxv = Math.max(maxv, ...azienda.r1.yp);

    var alfax = (1.0 * width - 2 * offx) / azienda.r1.xp.length;
    var betax = offx;
    var alfay = (height - 2 * offy) / (minv - maxv);
    var betay = offy - alfay * maxv;
    drawPred(c, azienda.r1.x, azienda.r1.y, azienda.r1.xp,azienda.r1.yp, `Predizioni ${azienda.azienda} elaborazione ${azienda.r1.ultimaElaborazione}`, { color1: "green", color2: "red", alfax, alfay, betax, betay })
    tabella("tabella",Math.round(azienda.r1.x.length/2),azienda.r1.x.length,azienda.r1.x, azienda.r1.y);
    tabella("previsioni",Math.round(azienda.r1.xp.length/2),azienda.r1.xp.length,azienda.r1.xp, azienda.r1.yp);
  }
  function drawPoints(c, err, title, { alfax, alfay, betax, betay, color }) {
    var canvas = c.getContext("2d");
    var width = c.width, height = c.height;
    var count = err.length;
    canvas.fillStyle = "white";
    canvas.fillRect(0, 0, width, height);
    //canvas.transform(10, 0, 0, 10, 0, -80);
    canvas.fillStyle = "black";
    canvas.moveTo(0, betay)
    canvas.lineTo(width, betay)
    canvas.moveTo(betax, 0)
    canvas.lineTo(betax, height)
    canvas.fillText(title, width / 2, 20)
    canvas.fillStyle = color;
    var count = err.length;
    var delta = Math.round(count / 10);

    for (var i = 0; i < count; i++) {
      var x = i * alfax + betax;
      var y = err[i] * alfay + betay;
      canvas.fillStyle = color;
      canvas.fillRect(x, y, 4, 4);
      canvas.fillStyle = "black";
      if (i % delta === 0) canvas.fillText("" + i, x, betay);
    }
  }
  function drawPred(c, xset, yset,x2,y2, title, { alfax, alfay, betax, betay, color1, color2 }) {
    var canvas = c.getContext("2d");
    var width = c.width, height = c.height;
    var count = xset.length;
    canvas.fillStyle = "white";
    canvas.fillRect(0, 0, width, height);
    //canvas.transform(10, 0, 0, 10, 0, -80);
    canvas.fillStyle = "black";
    canvas.beginPath();
    canvas.moveTo(0, betay)
    canvas.lineTo(width, betay)
    canvas.moveTo(betax, 0)
    canvas.lineTo(betax, height)
    canvas.stroke();
    canvas.fillText(title, width / 2, 20)
    var dy = height / 10;
    for (var i = 0; i < 10; i++) {
      var y = Math.round(i * dy - betay / alfay, 2);
      canvas.fillText("" + y, 0, height - i * dy)
    }
    var delta = Math.round(x2.length / 10);
    canvas.fillStyle = color1;
    canvas.beginPath();
    canvas.moveTo(betax, yset[0] * alfay + betay)
    for (var i = 1; i < count; i++) {
      var x = i * alfax + betax;
      var y = yset[i] * alfay + betay;
      canvas.lineTo(x, y);
    }
    canvas.stroke();
    for (var i = 0; i < x2.length; i++) {
      var x = i * alfax + betax;
      var y = y2[i] * alfay + betay;
      canvas.fillStyle = color2;
      canvas.fillRect(x, y, 4, 4);
      canvas.fillStyle = "black";
      if (i % delta === 0) canvas.fillText(x2[i].split("T")[0], x, height)
    }
    
  }
</script>

</html>